<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <meta charset="utf-8">
    <meta name="author" content="Rockefeller University, Bioinformatics Resource Centre" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="metropolisCustom.css" type="text/css" />
    <link rel="stylesheet" href="metropolis-fontsCustom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Analysis of ATAC-seq data in R and Bioconductor - Part2
<html>
<div style="float:left">

</div>
<hr color='#EB811B' size=1px width=796px>
</html>
### Rockefeller University, Bioinformatics Resource Centre
### <a href="http://rockefelleruniversity.github.io/Bioconductor_Introduction/" class="uri">http://rockefelleruniversity.github.io/Bioconductor_Introduction/</a>

---




# Greenleaf dataset characterisation and open region finding.

In this section we will work a little more with the Greenleaf dataset. 

We will characterise Greenleaf data signal around TSS regions and identify and annotated open regions as peak calls using MACS2.

At the end of the session we will look at plotting transposase cut-sites around DNA binding proteins.

---

# Encode dataset characterisation and open region finding.

In this session we will also take some of the Encode data for Liver, Kidney and Hindbrain and perform a differential analysis on open regions.

---


### The Sequencing Data.

In the ATACseq session we will make use of three sets of published data.

The first dataset is from original ATAC-seq paper.

Transposition of native chromatin for multimodal regulatory analysis and personal epigenomics
Jason D. Buenrostro, Paul G. Giresi, Lisa C. Zaba, Howard Y. Chang, and William J. Greenleaf

In particular, we will make use of the ATACseq_50k_Rep2 sample GEO - GSM1155958 
Data can be retrieved in fastq format from ENA  

* SAMN02192806 - [here](https://www.ebi.ac.uk/ena/data/view/SAMN02192806)

---

For the second dataset we take ATAC-seq generated by Bing Ren at UCSD as part of the Encode consortium. 
Links to data and sample information are included in list below.

* Liver day 12 - [ENCSR302LIV](https://www.encodeproject.org/experiments/ENCSR302LIV/)

* Kidney day 15 - [ENCSR023QZX](https://www.encodeproject.org/experiments/ENCSR023QZX/)

* Hindbrain day 12 - [ENCSR088UYE](https://www.encodeproject.org/experiments/ENCSR088UYE/)

---
Finally I have processed some of the data from Christina Leslie' lab at MSKCC exactly as described in last session so we can review some of the characteristics of ATAC-seq data alongside the same data processed by Encode's pipeline during the practical session.

The raw data and processed BAM file is available from Encodes portal

* T-Reg - [ENCSR724UJS](https://www.encodeproject.org/experiments/ENCSR724UJS/)

In todays practical we will work with some of the ATAC-seq data of T-regulatory cells from Christina Leslie's lab.

Aligned data as a BAM file [can be found here.](https://www.encodeproject.org/files/ENCFF053CGD/@@download/ENCFF053CGD.bam)


---
### Processed Data.

We start with public sequencing data in links below and use reference data in Bioconductor.

Since some of these processing steps may take a little time i provide links to pre-processed results.

**Essentials**

BAM file and BAI index from our alignment/sorting/indexing.

* [SAMN02192806 - Greenleaf BAM](https://s3.amazonaws.com/rubioinformatics/ATAC_Workshop/ATAC_Data/ATAC_BAM/Sorted_ATAC_50K_2.bam) - Full BAM file for Greenleaf example produced following in our Rsubread alignment, sorting and indexing.  

* [SAMN02192806 - Greenleaf BAI index](https://s3.amazonaws.com/rubioinformatics/ATAC_Workshop/ATAC_Data/ATAC_BAM/Sorted_ATAC_50K_2.bam.bai) - BAI index file for BAM in Greenleaf example produced following in our alignment, sorting and indexing. 

---
**Essentials**

Small BAM, peak calls and directory structure.

* [ATAC_Workshop_Essential.zip](https://s3.amazonaws.com/rubioinformatics/ATAC_Workshop_Essential.zip) - Require additional workshop files and directory structure.

Once you have downloaded the above and unzipped **ATAC_Workshop.zip**, you should move the **Sorted_ATAC_50K_2.bam** and **Sorted_ATAC_50K_2.bam.bai** file into **ATAC_Workshop/ATAC_Data/ATAC_BAM/**

You should also copy the **RU_ATAC_Workshop.Rmd** to **ATAC_Workshop/** directory and open then to make sure all relative paths are correct. 
---
**Not essential**

Same as above but with BAMs for counting as well as small BAM, peak calls and directory structure.

* [ATAC_Workshop.zip](https://s3.amazonaws.com/rubioinformatics/ATAC_Workshop.zip)  - Additional workshop files and directory structure.

Bigwigs for IGV.

* [Bigwigs](https://s3.amazonaws.com/rubioinformatics/ATAC_bigWigs.zip) - BigWigs to review in IGV. 

---
## ATAC-seq

&lt;div align="center"&gt;
&lt;img src="imgs/mnATAC.jpg" alt="offset" height="300" width="600"&gt;
&lt;/div&gt;

* ATAC-seq - Uses transposases and offers a method to simultaneously extract signal from transcription factors binding sites and nucleosome positions from a single sample.


---
# Working with ATAC-seq

This means our data potentially contains a mixture of signal types in our data.

* We will have signal from nucleosome free regions and around transcription factors (our shorter fragments).
* A portion of our signal will be from around nucleosomes in open chromatin (longer fragments).

All our data is from open chromatin where our transposase has been able to access.

&lt;div align="center"&gt;
&lt;img src="imgs/buenstro.png" alt="offset" height="300" width="600"&gt;
&lt;/div&gt;

---

##  Evaluating signal over TSS regions.

If our shorter fragments represent the open regions around transcription factors and transcriptional machinery we would expect to see signal at transcriptional start sites.

Our longer fragments will represent signal around nucleosomes and so signal should be outside of the transcriptional start sites and more present at the +1 and -1 nucleosome positions.

&lt;div align="center"&gt;
&lt;img src="imgs/phasing.png" alt="offset" height="300" width="400"&gt;
&lt;/div&gt;

---

##  Evaluating signal over TSS regions.

We can create a meta-plot over all TSS regions to illustrate where our nucleosome free and nucleosome occupied fractions of signal are most prevalent.

Meta-plots average or sum signal over sets of regions to identify trends in data.

&lt;div align="center"&gt;
&lt;img src="imgs/signalOverTSS.png" alt="offset" height="300" width="600"&gt;
&lt;/div&gt;

---

##  Plotting signal over regions in R.

To produce meta-plots of signal over regions we can use the **soGGi** bioconductor package. We will be using a development of soGGi however so we will need to install from the github repository.

To install packages from a Github directory we can take advantage of the **install_github()** function in the **devtools** package. The **install_github()** simply takes the **user and repository name** as a file path for library to install.

First we install the **devtools** library.


```r
install.packages("devtools")
library(devtools)
install_github("ThomasCarroll/soGGi")
```

---

##  Plotting signal over regions in R.

Now we have installed the **soGGi** library from github we can load as any standard library.


```r
library(soGGi)
```
---

##  Plotting regions in soGGi.

The soGGi library simply requires a BAM file and a GRanges of regions over which to average signal to produce the meta-plot.

We wish to plot over TSS regions and so we first will need to produce a GRanges of TSS locations for hg19 genome.

Thankfully we now know how to extract these regions for all genes using the **TxDB packages** and some **GenomicRanges** functions.

First we can load our TxDb of interest - **TxDb.Hsapiens.UCSC.hg19.knownGene**.


```r
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
TxDb.Hsapiens.UCSC.hg19.knownGene
```

```
## TxDb object:
## # Db type: TxDb
## # Supporting package: GenomicFeatures
## # Data source: UCSC
## # Genome: hg19
## # Organism: Homo sapiens
## # Taxonomy ID: 9606
## # UCSC Table: knownGene
## # Resource URL: http://genome.ucsc.edu/
## # Type of Gene ID: Entrez Gene ID
## # Full dataset: yes
## # miRBase build ID: GRCh37
## # transcript_nrow: 82960
## # exon_nrow: 289969
## # cds_nrow: 237533
## # Db created by: GenomicFeatures package from Bioconductor
## # Creation time: 2015-10-07 18:11:28 +0000 (Wed, 07 Oct 2015)
## # GenomicFeatures version at creation time: 1.21.30
## # RSQLite version at creation time: 1.0.0
## # DBSCHEMAVERSION: 1.1
```

---

##  Plotting regions in soGGi.

We can extract gene locations (TSS to TTS) [using the **genes()** function and our **TxDb** object.](https://rockefelleruniversity.github.io/Bioconductor_Introduction/r_course/presentations/slides/GenomicFeatures_In_Bioconductor.html#15)


```r
genesLocations &lt;- genes(TxDb.Hsapiens.UCSC.hg19.knownGene)
genesLocations
```

```
## GRanges object with 23056 ranges and 1 metadata column:
##         seqnames                 ranges strand |     gene_id
##            &lt;Rle&gt;              &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt;
##       1    chr19 [ 58858172,  58874214]      - |           1
##      10     chr8 [ 18248755,  18258723]      + |          10
##     100    chr20 [ 43248163,  43280376]      - |         100
##    1000    chr18 [ 25530930,  25757445]      - |        1000
##   10000     chr1 [243651535, 244006886]      - |       10000
##     ...      ...                    ...    ... .         ...
##    9991     chr9 [114979995, 115095944]      - |        9991
##    9992    chr21 [ 35736323,  35743440]      + |        9992
##    9993    chr22 [ 19023795,  19109967]      - |        9993
##    9994     chr6 [ 90539619,  90584155]      + |        9994
##    9997    chr22 [ 50961997,  50964905]      - |        9997
##   -------
##   seqinfo: 93 sequences (1 circular) from hg19 genome
```


---
#  Plotting regions in soGGi.

We can then use the [**resize()** function](https://rockefelleruniversity.github.io/Bioconductor_Introduction/r_course/presentations/slides/GenomicIntervals_In_Bioconductor.html#34) to extract the location of start of every gene (the TSSs) in a stranded manner.

Here we set the **fix** position as the start and the width as 1.


```r
tssLocations &lt;- resize(genesLocations,fix="start",width = 1)
tssLocations
```

```
## GRanges object with 23056 ranges and 1 metadata column:
##         seqnames                 ranges strand |     gene_id
##            &lt;Rle&gt;              &lt;IRanges&gt;  &lt;Rle&gt; | &lt;character&gt;
##       1    chr19 [ 58874214,  58874214]      - |           1
##      10     chr8 [ 18248755,  18248755]      + |          10
##     100    chr20 [ 43280376,  43280376]      - |         100
##    1000    chr18 [ 25757445,  25757445]      - |        1000
##   10000     chr1 [244006886, 244006886]      - |       10000
##     ...      ...                    ...    ... .         ...
##    9991     chr9 [115095944, 115095944]      - |        9991
##    9992    chr21 [ 35736323,  35736323]      + |        9992
##    9993    chr22 [ 19109967,  19109967]      - |        9993
##    9994     chr6 [ 90539619,  90539619]      + |        9994
##    9997    chr22 [ 50964905,  50964905]      - |        9997
##   -------
##   seqinfo: 93 sequences (1 circular) from hg19 genome
```

---
#  Plotting regions in soGGi.

The soGGi package's **regionPlot()** function requires a BAM file of data to plot supplied to **bamFile** parameter and a GRanges to plot over supplied to **testRanges** argument.



```r
library(soGGi)
sortedBAM &lt;- "~/Downloads/ATAC_Workshop/ATAC_Data/ATAC_BAM/Sorted_ATAC_50K_2.bam"

library(Rsamtools)
# Nucleosome free
allSignal &lt;- regionPlot(bamFile = sortedBAM,
                        testRanges = tssLocations)
```

---
#  Plotting regions in soGGi.

Additionally we supply information on input file format to **format** parameter, whether data is paired to **paired** parameter and type of plot to **style** parameter. We look at different **style** options in later visualisation sessions.

Usefully we can specify the minimum and maximum fragment lengths of paired reads to be used in our plot with the **minFragmentLength** and **maxFragmentLength** functions. This allows us to select only our nucleosome free signal (&lt; 100 base-pairs) to produce our metaplot over TSS regions.


```r
nucFree &lt;- regionPlot(bamFile = sortedBAM,
                        testRanges = tssLocations,
                        style = "point",
                        format="bam",
                        paired=TRUE,
                        minFragmentLength = 0,
                        maxFragmentLength = 100,
                        forceFragment = 50)
class(monoNuc)
```
---
##  Plotting regions in soGGi.

Now we have our profile object we can create our metaplot using the **plotRegion()** function in **soGGi**.

Here we see the expected peak of signal for our nucleosome free region in the region over the TSS.


```r
plotRegion(nucFree)
```

![](RU_ATAC_part2_files/figure-html/processData_plot2-1.png)&lt;!-- --&gt;


---

##  Plotting regions in soGGi.

We can create a plot for our mono-nucleosome signal by adjusting our **minFragmentLength** and **maxFragmentLength** parameters to those expected for nucleosome length fragments (here 180 to 240).


```r
monoNuc &lt;- regionPlot(bamFile = sortedBAM,
                        testRanges = tssLocations,
                        style = "point",
                        format="bam",
                        paired=TRUE,
                        minFragmentLength = 180,maxFragmentLength = 240,forceFragment = 80)
save(monoNuc,file = "../../Data/monoNuc_TSS.RData")
```
---
##  Plotting regions in soGGi.

Similarly we can plot the mono-nucleosome signal over TSS locations using **plotRegion()** function.

In this plot we can clearly see the expected +1 nucleosome signal peak as well as several other nucleosome signalpeaks


```r
plotRegion(monoNuc)
```

![](RU_ATAC_part2_files/figure-html/processData_plot4-1.png)&lt;!-- --&gt;


---
# Greenleaf dataset - Finding Open Regions.

A common goal in ATAC-seq is to identify nucleosome free regions where transcription factors are binding and/or transcriptional machinery is active. This nucleosome free signal would correspond to fragments less than one nucleosome (as defined in Greenleaf paper &lt; 100bp)

To identify open chromatin however we could simply use all reads which have been properly paired in sequencing (&lt; 2000bp).

For the remainder of the workshop we will look at analysing the nucleosome free portions of the our ATAC-seq data.

---
## Peak calling for nucleosome free regions.

There are many methods available to call nucleosome free regions from ATAC-seq data with many borrowed from ChIP-seq analysis.

One very popular and standard peak caller for ATAC-seq is MAC2.

MACS2 is well established for identifying punctate peaks found in ChIP-seq data from transcription factors.

MACS2 website can be found [here]() with information on parameters and use cases.

---
### Single end peak calling.

With single end sequencing from ATAC-seq we do not know how long the fragments are.

To identify open regions therefore requires some different parameters for MACS2 peak calling.

One strategy employed is to shift read 5' ends by -100 and then extend from this by 200bp. Considering the expected size of our nucleosome free fragments this should provide a pile-up over nucelosome regions suitable for MACS2 window size. 


```bash
MACS2 callpeak -t singleEnd.bam --nomodel --shift -100
                --extsize 200 --format BAM -g MyGenome
```

---

Alternatively for the nucleosome occupied data we can adjust shift and extension to centre the signal on nucleosome centres (nucleosomes wrapped in 147bp of DNA). 


```bash
MACS2 callpeak -t singleEnd.bam --nomodel --shift 37
               --extsize 73 --format BAM -g MyGenome
```
---
### Paired end peak calling.

If we have sequenced paired-end data then we do know the fragment lengths and can provide BAM files to MACS2 which have been prefiltered to properly paired (and fragment size if you want to distinguish nucleosomes from nucleosome free regions)

We have to simply tell MACS2 that the data is paired using the format argument.

By default MACS2 will guess it is single end BAM.


```bash
MACS2 callpeak -t pairedEnd.bam -f BAMPE 
               --outdir path/to/output/
               --name pairedEndPeakName -g MyGenome
```
---

For our pair-end data here, we call peaks on our nucleosome free regions from our nucleosome free region BAM file.



```bash
MACS2 callpeak  -t ~/Downloads/Sorted_ATAC_50K_2_openRegions.bam
                --outdir ATAC_Data/ATAC_Peaks/ATAC_50K_2
                --name Sorted_ATAC_50K_2_Small_Paired_peaks.narrowPeak
                -f BAMPE -g hs
```

---
### Paired end peak calling.

Following peak calling we would get 3 files we saw in our earlier ChIPseq session.

* Name.narrowPeak -- Narrow peak format suitable for IGV and further analysis

* Name_peaks.xls -- Peak table suitable for review in excel.(not actually a xls but a tsv)

* summits.bed -- Summit positions for peaks useful for finding motifs and plotting

---
## QC for low quality, duplicates and signal distribution.

Before we remove any data we can get a quick assessment of our reads in peaks, duplication rate, low quality reads and reads in artefact regions from ChIPQC.


```r
library(ChIPQC)
library(rtracklayer)
library(DT)
library(dplyr)
library(tidyr)

blkList &lt;- import.bed("../../Data/ENCFF001TDO.bed.gz")
openRegionPeaks &lt;- "../../Data/Sorted_ATAC_50K_2_Small_Paired_peaks.narrowPeak"

qcRes &lt;- ChIPQCsample("~/Downloads/ATAC_Workshop/ATAC_Data/ATAC_BAM/Sorted_ATAC_50K_2_openRegions.bam",
                      peaks = openRegionPeaks,
                      annotation ="hg19",
                      chromosomes = "chr20",
                      blacklist = blkList,
                      verboseT = FALSE)
save(qcRes,file="../../Data/qcRes.RData")
```

---
## QC for low quality, duplicates and signal distribution.

We can use the ChIPQC package to capture some important metrics for our ATAC-seq data such as reads in peaks and reads in blacklist from the **QCmetrics()** function and numbers of duplicated reads from the **flagtagcounts()** funcion.




```r
myMetrics &lt;- QCmetrics(qcRes)
myMetrics[c("RiBL%","RiP%")]
```

```
##  RiBL%   RiP% 
##  0.342 12.300
```

```r
flgCounts &lt;- flagtagcounts(qcRes)
DupRate &lt;- flgCounts["DuplicateByChIPQC"]/flgCounts["Mapped"]
DupRate*100
```

```
## DuplicateByChIPQC 
##          22.90539
```
---



##  Remove blacklisted peaks 

Since blacklisted regions may confound our analysis we remove any peaks which have been called there. 

Removing blacklists too early can hide some of the qc issues in your data. The **blacklist** should always be considered in your analysis and recommended to removed data from these regions once QC is considered.


```r
MacsCalls &lt;- granges(qcRes[seqnames(qcRes) %in% "chr20"])

data.frame(Blacklisted=sum(MacsCalls %over% blkList),
           Not_Blacklisted=sum(!MacsCalls %over% blkList))
```

```
##   Blacklisted Not_Blacklisted
## 1           2             596
```

```r
MacsCalls &lt;- MacsCalls[!MacsCalls %over% blkList]
```

---

# Greenleaf dataset - Annotating Open Regions.

It is often of interest to associate identified nucleosome free regions to genomic features such as genes and enhancers.

Once annotated to genes or enhancers' genes, we can start to associate ATAC-seq data to characteristics of these genes. (functional annotation, expression changes, other epigenetic states)

---
### Annotating peaks to genes.

A simple approach to annotating nucleosome free region to genes is to associate regions to their closest gene or within a window around a genes transcriptional start site.

We can use the [chipseeker library to identify genes closest to our regions and to give us simple summaries and visualisations of this annotation.](https://rockefelleruniversity.github.io/RU_ChIPseq/chipseq_course/Presentations/Slides/ChIPseq_In_Bioconductor2.html#45)

We use the gene models from TxDb.Hsapiens.UCSC.hg19.knownGene and supply this to ChIPseeker packages annotatePeak function.

ChIPseeker's csAnno object will then show breakdown of percentages of peaks in genomic regions.


```r
library(ChIPseeker)
library(TxDb.Hsapiens.UCSC.hg19.knownGene)
MacsCalls_Anno &lt;-  annotatePeak(MacsCalls,
                                TxDb = TxDb.Hsapiens.UCSC.hg19.knownGene)
```

```
## &gt;&gt; preparing features information...		 2018-12-16 16:37:11 
## &gt;&gt; identifying nearest features...		 2018-12-16 16:37:12 
## &gt;&gt; calculating distance from peak to TSS...	 2018-12-16 16:37:13 
## &gt;&gt; assigning genomic annotation...		 2018-12-16 16:37:13 
## &gt;&gt; assigning chromosome lengths			 2018-12-16 16:37:32 
## &gt;&gt; done...					 2018-12-16 16:37:32
```

```r
MacsCalls_Anno
```

```
## Annotated peaks generated by ChIPseeker
## 596/596  peaks were annotated
## Genomic Annotation Summary:
##               Feature  Frequency
## 9    Promoter (&lt;=1kb) 40.2684564
## 10   Promoter (1-2kb)  2.0134228
## 11   Promoter (2-3kb)  2.1812081
## 4              5' UTR  0.1677852
## 3              3' UTR  1.0067114
## 1            1st Exon  0.1677852
## 7          Other Exon  1.5100671
## 2          1st Intron  6.0402685
## 8        Other Intron 19.9664430
## 6  Downstream (&lt;=3kb)  0.8389262
## 5   Distal Intergenic 25.8389262
```
---
### Displaying annotation distribution

As well as showing us a table of the annotation distribution we can visualise this using the plotAnnoPie and plotAnnoBar functions.


```r
plotAnnoPie(MacsCalls_Anno)
```

![](RU_ATAC_part2_files/figure-html/processData_Pie-1.png)&lt;!-- --&gt;

---

### Retrieving annotated Nucleosome-free regions.

With this information we can then subset our peaks/nuc free regions to those only landing in TSS regions (+/- 500)


```r
MacsGR_Anno &lt;- as.GRanges(MacsCalls_Anno)
MacsGR_TSS &lt;-   MacsGR_Anno[abs(MacsGR_Anno$distanceToTSS) &lt; 500]
MacsGR_TSS[1,]
```

```
## GRanges object with 1 range and 9 metadata columns:
##       seqnames           ranges strand |       annotation   geneChr
##          &lt;Rle&gt;        &lt;IRanges&gt;  &lt;Rle&gt; |      &lt;character&gt; &lt;integer&gt;
##   [1]    chr20 [278001, 278160]      * | Promoter (&lt;=1kb)        20
##       geneStart   geneEnd geneLength geneStrand      geneId transcriptId
##       &lt;integer&gt; &lt;integer&gt;  &lt;integer&gt;  &lt;integer&gt; &lt;character&gt;  &lt;character&gt;
##   [1]    278204    280963       2760          1       85364   uc002wdf.3
##       distanceToTSS
##           &lt;numeric&gt;
##   [1]           -44
##   -------
##   seqinfo: 1 sequence from hg19 genome
```

---
### Functional Analysis of Nucleosome-free regions - 1.

Another common step to ATAC-seq analysis is to identify any functional enrichment in genes associated to nucleosome free regions.

One approach is to take the genes we identified from ChIPseeker as having nuclesome free regions and test these for functional enrichment using standard tools. 

[Another approach which is well suited to ATAC-seq is that implemented in GREAT.](https://rockefelleruniversity.github.io/RU_ChIPseq/chipseq_course/Presentations/Slides/ChIPseq_In_Bioconductor3.html#24)

**rGREAT by default will limit our queries and so we may need to be patient. This can be adjusted in rGREAT options.**

---
### Functional Analysis of Nucleosome-free regions - 1.

We can submit our peak calls to GREAT using the **submitGreatJob** function and review available categories of results using **availableCategories**.


```r
library(rGREAT)
great_Job &lt;- submitGreatJob(MacsCalls, species = "hg19")
availableCategories(great_Job)
```

```
## [1] "GO"                               "Phenotype Data and Human Disease"
## [3] "Pathway Data"                     "Gene Expression"                 
## [5] "Regulatory Motifs"                "Gene Families"
```
---
### Functional Analysis of Nucleosome-free regions - 2.

For this example we select the results tables for the GO category using getEnrichmentTables functions and then review the results for Biological processes.


```r
great_ResultTable = getEnrichmentTables(great_Job, category = "GO")
names(great_ResultTable)          
```

```
## [1] "GO Molecular Function" "GO Biological Process" "GO Cellular Component"
```

```r
great_ResultTable[["GO Biological Process"]][1:4, ]
```

```
##           ID                                             name
## 1 GO:0035723        interleukin-15-mediated signaling pathway
## 2 GO:2000438    negative regulation of monocyte extravasation
## 3 GO:2000560 positive regulation of CD24 biosynthetic process
## 4 GO:2000437             regulation of monocyte extravasation
##   Binom_Genome_Fraction Binom_Expected Binom_Observed_Region_Hits
## 1          0.0003871583      0.2307463                         15
## 2          0.0003871583      0.2307463                         15
## 3          0.0003871583      0.2307463                         15
## 4          0.0004297120      0.2561083                         15
##   Binom_Fold_Enrichment Binom_Region_Set_Coverage Binom_Raw_PValue
## 1              65.00645                0.02516779     1.451510e-22
## 2              65.00645                0.02516779     1.451510e-22
## 3              65.00645                0.02516779     1.451510e-22
## 4              58.56896                0.02516779     6.777858e-22
##   Hyper_Total_Genes Hyper_Expected Hyper_Observed_Gene_Hits
## 1                 1     0.01973283                        1
## 2                 1     0.01973283                        1
## 3                 1     0.01973283                        1
## 4                 2     0.03946566                        1
##   Hyper_Fold_Enrichment Hyper_Gene_Set_Coverage Hyper_Term_Gene_Coverage
## 1              50.67697             0.002808989                      1.0
## 2              50.67697             0.002808989                      1.0
## 3              50.67697             0.002808989                      1.0
## 4              25.33848             0.002808989                      0.5
##   Hyper_Raw_PValue
## 1       0.01973283
## 2       0.01973283
## 3       0.01973283
## 4       0.03907735
```

```r
save(great_ResultTable,file="../../Data/Great_Results.RData")
```
---
## Differential ATAC-seq

We have briefly reviewed the processing and initial analysis of one ATAC-seq sample using R.

In the next part we will look at how we can identify changes in open regions using R/Bioconductor.

Here we will take an approach akin that in Diffbind and reasonably esatablished in ATAC-seq analysis. 

---
## Identifying a set of non-redundant peaks.

First, We will define a set of non-redundant peaks present in at least 2 samples and use these to assess changes in nuc-free ATAC-seq signal using DESeq2.

[Here we use the same method for deriving consensus peaks for differentials as seen for ChIPseq.](https://rockefelleruniversity.github.io/RU_ChIPseq/chipseq_course/Presentations/Slides/ChIPseq_In_Bioconductor4.html#22)


```r
peaks &lt;- dir("~/Downloads/demo/ATAC_Workshop/ATAC_Data/ATAC_Peaks_forCounting/",
             pattern="*.narrowPeak",full.names=TRUE)
myPeaks &lt;- lapply(peaks,ChIPQC:::GetGRanges,simple=TRUE)
allPeaksSet_nR &lt;- reduce(unlist(GRangesList(myPeaks)))
overlap &lt;- list()
for(i in 1:length(myPeaks)){
  overlap[[i]] &lt;- allPeaksSet_nR %over% myPeaks[[i]]
}
overlapMatrix &lt;- do.call(cbind,overlap)
colnames(overlapMatrix) &lt;- basename(peaks)
mcols(allPeaksSet_nR) &lt;- overlapMatrix
```
---
## Identifying a set of non-redundant peaks.



```r
allPeaksSet_nR[1:2,]
```

```
## GRanges object with 2 ranges and 6 metadata columns:
##       seqnames             ranges strand |
##          &lt;Rle&gt;          &lt;IRanges&gt;  &lt;Rle&gt; |
##   [1]     chr1 [3130336, 3130413]      * |
##   [2]     chr1 [3400112, 3400250]      * |
##       Sorted_Hindbrain_day_12_1_Small_Paired_peaks.narrowPeak
##                                                     &lt;logical&gt;
##   [1]                                                   FALSE
##   [2]                                                   FALSE
##       Sorted_Hindbrain_day_12_2_Small_Paired_peaks.narrowPeak
##                                                     &lt;logical&gt;
##   [1]                                                   FALSE
##   [2]                                                   FALSE
##       Sorted_Kidney_day_15_1_Small_Paired_peaks.narrowPeak
##                                                  &lt;logical&gt;
##   [1]                                                FALSE
##   [2]                                                FALSE
##       Sorted_Kidney_day_15_2_Small_Paired_peaks.narrowPeak
##                                                  &lt;logical&gt;
##   [1]                                                 TRUE
##   [2]                                                 TRUE
##       Sorted_Liver_day_12_1_Small_Paired_peaks.narrowPeak
##                                                 &lt;logical&gt;
##   [1]                                               FALSE
##   [2]                                               FALSE
##       Sorted_Liver_day_12_2_Small_Paired_peaks.narrowPeak
##                                                 &lt;logical&gt;
##   [1]                                               FALSE
##   [2]                                               FALSE
##   -------
##   seqinfo: 22 sequences from an unspecified genome; no seqlengths
```
---
## Identifying a set of non-redundant peaks.

We filter out peaks in blacklists and in ChrM prior to testing to eliminate potential artefact differential calls.


```r
blklist &lt;- import.bed("../../Data/ENCFF547MET.bed.gz")
nrToCount &lt;- allPeaksSet_nR[!allPeaksSet_nR %over% blklist 
                            &amp; !seqnames(allPeaksSet_nR) %in% "chrM"]
nrToCount
```

```
## GRanges object with 89654 ranges and 6 metadata columns:
##           seqnames               ranges strand |
##              &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; |
##       [1]     chr1   [3130336, 3130413]      * |
##       [2]     chr1   [3400112, 3400250]      * |
##       [3]     chr1   [3433954, 3434095]      * |
##       [4]     chr1   [3515020, 3515102]      * |
##       [5]     chr1   [3575895, 3576078]      * |
##       ...      ...                  ...    ... .
##   [89650]     chrY [90805058, 90805151]      * |
##   [89651]     chrY [90807391, 90807562]      * |
##   [89652]     chrY [90808761, 90808841]      * |
##   [89653]     chrY [90812961, 90813237]      * |
##   [89654]     chrY [90829708, 90829782]      * |
##           Sorted_Hindbrain_day_12_1_Small_Paired_peaks.narrowPeak
##                                                         &lt;logical&gt;
##       [1]                                                   FALSE
##       [2]                                                   FALSE
##       [3]                                                   FALSE
##       [4]                                                   FALSE
##       [5]                                                   FALSE
##       ...                                                     ...
##   [89650]                                                   FALSE
##   [89651]                                                   FALSE
##   [89652]                                                   FALSE
##   [89653]                                                    TRUE
##   [89654]                                                   FALSE
##           Sorted_Hindbrain_day_12_2_Small_Paired_peaks.narrowPeak
##                                                         &lt;logical&gt;
##       [1]                                                   FALSE
##       [2]                                                   FALSE
##       [3]                                                   FALSE
##       [4]                                                   FALSE
##       [5]                                                   FALSE
##       ...                                                     ...
##   [89650]                                                   FALSE
##   [89651]                                                   FALSE
##   [89652]                                                    TRUE
##   [89653]                                                    TRUE
##   [89654]                                                   FALSE
##           Sorted_Kidney_day_15_1_Small_Paired_peaks.narrowPeak
##                                                      &lt;logical&gt;
##       [1]                                                FALSE
##       [2]                                                FALSE
##       [3]                                                 TRUE
##       [4]                                                FALSE
##       [5]                                                 TRUE
##       ...                                                  ...
##   [89650]                                                FALSE
##   [89651]                                                 TRUE
##   [89652]                                                FALSE
##   [89653]                                                 TRUE
##   [89654]                                                FALSE
##           Sorted_Kidney_day_15_2_Small_Paired_peaks.narrowPeak
##                                                      &lt;logical&gt;
##       [1]                                                 TRUE
##       [2]                                                 TRUE
##       [3]                                                 TRUE
##       [4]                                                 TRUE
##       [5]                                                 TRUE
##       ...                                                  ...
##   [89650]                                                FALSE
##   [89651]                                                FALSE
##   [89652]                                                FALSE
##   [89653]                                                FALSE
##   [89654]                                                 TRUE
##           Sorted_Liver_day_12_1_Small_Paired_peaks.narrowPeak
##                                                     &lt;logical&gt;
##       [1]                                               FALSE
##       [2]                                               FALSE
##       [3]                                               FALSE
##       [4]                                               FALSE
##       [5]                                               FALSE
##       ...                                                 ...
##   [89650]                                                TRUE
##   [89651]                                               FALSE
##   [89652]                                               FALSE
##   [89653]                                                TRUE
##   [89654]                                               FALSE
##           Sorted_Liver_day_12_2_Small_Paired_peaks.narrowPeak
##                                                     &lt;logical&gt;
##       [1]                                               FALSE
##       [2]                                               FALSE
##       [3]                                               FALSE
##       [4]                                               FALSE
##       [5]                                               FALSE
##       ...                                                 ...
##   [89650]                                               FALSE
##   [89651]                                                TRUE
##   [89652]                                               FALSE
##   [89653]                                                TRUE
##   [89654]                                               FALSE
##   -------
##   seqinfo: 22 sequences from an unspecified genome; no seqlengths
```
---
# Counting for differential ATAC-seq.

We now identify the number of samples in which our non-redundant peaks occur. Here we use the **rowSums()** function with our occurrence matrix and select those samples occuring in more than 2 samples.


```r
library(Rsubread)
occurrences &lt;- rowSums(
  as.data.frame(elementMetadata(nrToCount)
                )
  )

nrToCount &lt;- nrToCount[occurrences &gt;= 2,]
nrToCount
```

```
## GRanges object with 36320 ranges and 6 metadata columns:
##           seqnames               ranges strand |
##              &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt; |
##       [1]     chr1   [3433954, 3434095]      * |
##       [2]     chr1   [3575895, 3576078]      * |
##       [3]     chr1   [3671534, 3671885]      * |
##       [4]     chr1   [3994858, 3995006]      * |
##       [5]     chr1   [4560267, 4560344]      * |
##       ...      ...                  ...    ... .
##   [36316]     chrY [90784207, 90784298]      * |
##   [36317]     chrY [90784944, 90785099]      * |
##   [36318]     chrY [90801504, 90801651]      * |
##   [36319]     chrY [90807391, 90807562]      * |
##   [36320]     chrY [90812961, 90813237]      * |
##           Sorted_Hindbrain_day_12_1_Small_Paired_peaks.narrowPeak
##                                                         &lt;logical&gt;
##       [1]                                                   FALSE
##       [2]                                                   FALSE
##       [3]                                                   FALSE
##       [4]                                                    TRUE
##       [5]                                                   FALSE
##       ...                                                     ...
##   [36316]                                                   FALSE
##   [36317]                                                    TRUE
##   [36318]                                                    TRUE
##   [36319]                                                   FALSE
##   [36320]                                                    TRUE
##           Sorted_Hindbrain_day_12_2_Small_Paired_peaks.narrowPeak
##                                                         &lt;logical&gt;
##       [1]                                                   FALSE
##       [2]                                                   FALSE
##       [3]                                                   FALSE
##       [4]                                                    TRUE
##       [5]                                                    TRUE
##       ...                                                     ...
##   [36316]                                                   FALSE
##   [36317]                                                    TRUE
##   [36318]                                                   FALSE
##   [36319]                                                   FALSE
##   [36320]                                                    TRUE
##           Sorted_Kidney_day_15_1_Small_Paired_peaks.narrowPeak
##                                                      &lt;logical&gt;
##       [1]                                                 TRUE
##       [2]                                                 TRUE
##       [3]                                                 TRUE
##       [4]                                                FALSE
##       [5]                                                 TRUE
##       ...                                                  ...
##   [36316]                                                FALSE
##   [36317]                                                 TRUE
##   [36318]                                                 TRUE
##   [36319]                                                 TRUE
##   [36320]                                                 TRUE
##           Sorted_Kidney_day_15_2_Small_Paired_peaks.narrowPeak
##                                                      &lt;logical&gt;
##       [1]                                                 TRUE
##       [2]                                                 TRUE
##       [3]                                                 TRUE
##       [4]                                                FALSE
##       [5]                                                FALSE
##       ...                                                  ...
##   [36316]                                                 TRUE
##   [36317]                                                 TRUE
##   [36318]                                                 TRUE
##   [36319]                                                FALSE
##   [36320]                                                FALSE
##           Sorted_Liver_day_12_1_Small_Paired_peaks.narrowPeak
##                                                     &lt;logical&gt;
##       [1]                                               FALSE
##       [2]                                               FALSE
##       [3]                                                TRUE
##       [4]                                               FALSE
##       [5]                                               FALSE
##       ...                                                 ...
##   [36316]                                                TRUE
##   [36317]                                                TRUE
##   [36318]                                                TRUE
##   [36319]                                               FALSE
##   [36320]                                                TRUE
##           Sorted_Liver_day_12_2_Small_Paired_peaks.narrowPeak
##                                                     &lt;logical&gt;
##       [1]                                               FALSE
##       [2]                                               FALSE
##       [3]                                               FALSE
##       [4]                                               FALSE
##       [5]                                               FALSE
##       ...                                                 ...
##   [36316]                                               FALSE
##   [36317]                                                TRUE
##   [36318]                                                TRUE
##   [36319]                                                TRUE
##   [36320]                                                TRUE
##   -------
##   seqinfo: 22 sequences from an unspecified genome; no seqlengths
```
---
# Counting for differential ATAC-seq.

Now we have to set of regions to count in we can use **summariseOverlaps()** to count paired reads landing in peaks as we have done for ChIPseq. 

We have to adjust our counting for paired-end reads so we additionally set the **singleEnd** parameter to FALSE.



```r
library(GenomicAlignments)
bamsToCount &lt;- dir("~/Downloads/ATAC_Workshop/ATAC_Data/ATAC_BAM_forCounting/",
                   full.names = TRUE,pattern = "*.\\.bam$")

myCounts &lt;- summarizeOverlaps(consensusToCount,
                              bamsToCount,singleEnd=FALSE)

colnames(myCounts) &lt;- c("HindBrain_1","HindBrain_2","Kidney_1","Kidney_2",
                        "Liver_1","Liver_2")
save(myCounts,file="../../Data/myCounts.RData")
```
---
## DESeq2 for differential ATAC-seq.

With our counts of fragments in nucleosome free regions we can now contruct a DESeq2 object.

We pass the GRanges of regions we count to DESeqDataSetFromMatrix function so as to access these from DESeq2 later.


```r
library(DESeq2)
load("../../Data/myCounts.RData")
Group &lt;- factor(c("HindBrain","HindBrain","Kidney","Kidney",
                  "Liver","Liver"))
metaData &lt;- data.frame(Group,row.names=colnames(myCounts))

atacDDS &lt;- DESeqDataSetFromMatrix(assay(myCounts),
                                  metaData,
                                  ~Group,
                                  rowRanges=rowRanges(myCounts))
atacDDS &lt;- DESeq(atacDDS)
```

```
## estimating size factors
```

```
## estimating dispersions
```

```
## gene-wise dispersion estimates
```

```
## mean-dispersion relationship
```

```
## -- note: fitType='parametric', but the dispersion trend was not well captured by the
##    function: y = a/x + b, and a local regression fit was automatically substituted.
##    specify fitType='local' or 'mean' to avoid this message next time.
```

```
## final dispersion estimates
```

```
## fitting model and testing
```
---
## DESeq2 for differential ATAC-seq.

With the new DESeq2 object we can now test for any differences in ATAC-seq signal between groups.

In this example we look at differences between hindbrain and Kidney samples. 

We return a GRanges object here to allow us to perform some more GenomicRanges operations.


```r
KidneyMinusHindbrain &lt;- results(atacDDS,
                                c("Group","Kidney","HindBrain"),
                               format="GRanges")
KidneyMinusHindbrain &lt;- KidneyMinusHindbrain[
                                order(KidneyMinusHindbrain$pvalue)
                         ]
KidneyMinusHindbrain
```

```
## GRanges object with 36320 ranges and 6 metadata columns:
##           seqnames                 ranges strand |         baseMean
##              &lt;Rle&gt;              &lt;IRanges&gt;  &lt;Rle&gt; |        &lt;numeric&gt;
##       [1]     chr4 [ 22488379,  22488925]      * | 96.8199189237331
##       [2]     chr1 [ 24613428,  24614006]      * | 285.253321607077
##       [3]     chrX [143483004, 143483128]      * | 1130.41292754113
##       [4]     chr2 [150644059, 150644430]      * | 36.0214355812973
##       [5]    chr15 [ 66239217,  66239619]      * | 32.3408041446888
##       ...      ...                    ...    ... .              ...
##   [36316]     chr9 [ 67261138,  67261364]      * | 4.94711355491016
##   [36317]     chrX [134541619, 134541788]      * | 9.40497828393043
##   [36318]    chr11 [117654162, 117654267]      * | 10.1494253446845
##   [36319]    chr12 [ 91589877,  91590440]      * | 58.1619989218353
##   [36320]     chr8 [119992279, 119992518]      * | 10.8936565603017
##                  log2FoldChange             lfcSE                  stat
##                       &lt;numeric&gt;         &lt;numeric&gt;             &lt;numeric&gt;
##       [1]     -3.48475772870562 0.271901280241101     -12.8162608341366
##       [2]      1.46558333790056 0.161635085933013      9.06723518251441
##       [3]     -1.22535605555799 0.148089457899026     -8.27443136697474
##       [4]      -4.1723509382131 0.521680967461527     -7.99789756278736
##       [5]     -4.44790088645107 0.583489013518654      -7.6229385359436
##       ...                   ...               ...                   ...
##   [36316] -0.000118234239499816  1.27198655700247 -9.29524285055683e-05
##   [36317] -5.68577195759627e-05 0.829590654398687  -6.8537078225857e-05
##   [36318] -2.40307009953284e-05  0.72800341211518 -3.30090499514396e-05
##   [36319]  5.06547902487156e-06 0.298726575504034  1.69569078891783e-05
##   [36320]  8.15151696651603e-06 0.608737540837442  1.33908563537941e-05
##                         pvalue                 padj
##                      &lt;numeric&gt;            &lt;numeric&gt;
##       [1] 1.32959371249996e-37 4.64174460970861e-33
##       [2] 1.22075221943078e-19  2.1308840366274e-15
##       [3] 1.29070090207996e-16 1.50198863975045e-12
##       [4] 1.26561592844221e-15 1.10459794194615e-11
##       [5] 2.47964969154329e-14 1.73134100762935e-10
##       ...                  ...                  ...
##   [36316]    0.999925834692513     0.99998931564246
##   [36317]    0.999945315323484     0.99998931564246
##   [36318]    0.999973662588682     0.99998931564246
##   [36319]    0.999986470344997     0.99998931564246
##   [36320]     0.99998931564246     0.99998931564246
##   -------
##   seqinfo: 22 sequences from an unspecified genome; no seqlengths
```

---
## DESeq2 for differential ATAC-seq.


We can subset to only open regions within promoters and then create a table to review the results in IGV using makebedtable function in tracktables package. 


```r
library(TxDb.Mmusculus.UCSC.mm10.knownGene)
toOverLap &lt;- promoters(TxDb.Mmusculus.UCSC.mm10.knownGene,
                       500,500)
KidneyMinusHindbrain &lt;- KidneyMinusHindbrain[
                          (!is.na(KidneyMinusHindbrain$padj) 
                           &amp; KidneyMinusHindbrain$padj &lt; 0.05) 
                           &amp; KidneyMinusHindbrain %over% toOverLap,]
makebedtable(KidneyMinusHindbrain,"KidneyMinusHindbrain.html",getwd())
```

```
## [1] "/Users/tcarroll/Projects/Software/Github/RU_ATACseq/atacseq_course/Presentations/Slides/KidneyMinusHindbrain.html"
```
---
## Annotation for differential ATAC-seq.

In the final part we can annotate our differential ATAC-seq regions to genes and then use gene information to test enrichment for GO sets.

Since we have subset regions to those within +/- 500bp of a TSS we can use a standard enrichment analysis at this point. Here we use clusterProfiler to identify enrichment


```r
anno_KidneyMinusHindbrain &lt;- annotatePeak(KidneyMinusHindbrain,
                                          TxDb = TxDb.Mmusculus.UCSC.mm10.knownGene)
```

```
## &gt;&gt; preparing features information...		 2018-12-16 16:38:28 
## &gt;&gt; identifying nearest features...		 2018-12-16 16:38:28 
## &gt;&gt; calculating distance from peak to TSS...	 2018-12-16 16:38:29 
## &gt;&gt; assigning genomic annotation...		 2018-12-16 16:38:29 
## &gt;&gt; assigning chromosome lengths			 2018-12-16 16:38:40 
## &gt;&gt; done...					 2018-12-16 16:38:40
```

```r
DB_ATAC &lt;- as.data.frame(anno_KidneyMinusHindbrain)
DB_ATAC[1,]
```

```
##   seqnames    start      end width strand baseMean log2FoldChange
## 1     chr4 22488379 22488925   547      * 96.81992      -3.484758
##       lfcSE      stat       pvalue         padj       annotation geneChr
## 1 0.2719013 -12.81626 1.329594e-37 4.641745e-33 Promoter (&lt;=1kb)       4
##   geneStart  geneEnd geneLength geneStrand geneId transcriptId
## 1  22482095 22488366       6272          2  18992   uc008sdp.2
##   distanceToTSS
## 1           -13
```

---
## Annotation for differential ATAC-seq.

Since we have subset regions to those within +/- 500bp of a TSS we can use a standard enrichment analysis at this point. Here we use clusterProfiler to identify enrichment


```r
library(clusterProfiler)
go &lt;- enrichGO(DB_ATAC$geneId, 
                OrgDb = "org.Mm.eg.db",ont = "BP",maxGSSize = 5000)
go[1:2,1:6]
```

```
##                    ID                                      Description
## GO:0051494 GO:0051494 negative regulation of cytoskeleton organization
## GO:0007399 GO:0007399                       nervous system development
##            GeneRatio    BgRatio       pvalue     p.adjust
## GO:0051494    19/441  128/23454 3.694502e-12 8.907243e-09
## GO:0007399    87/441 2164/23454 7.081771e-12 8.907243e-09
```

---
## Cutting sites from ATAC-seq data

ATAC-seq should generate shorter fragments (our nucleosome free regions) around smaller *protected* areas such as transcription factor binding sites.

We can therefore look for the pile-up of cut-sites around motifs of interest within different tissues/celltypes/samples.

To produce cut-sites from our BAM file we first resize our reads to 1bp and make the shift of 4/-5 bp depending on strand to adjust for expected shift from insertion of Tn5 transposase.

Here we will identify CTCF motifs passing an arbitary cut-off and then use soGGi to plot cut-sites around them

---
## Finding motifs

We need to identify the position of CTCF motifs across the genome so first we need to know what a CTCF motif looks like.

The motifDB package contains information on Motifs from public databases such as Jaspar. Here we use the **query()** function with our motif of interest (**CTCF**) to extract the CTCF motif.


```r
library(MotifDb)
library(Biostrings)
library(BSgenome.Hsapiens.UCSC.hg19)
CTCF &lt;- query(MotifDb, c("CTCF"))
CTCF
```

```
## MotifDb object of length 4
## | Created from downloaded public sources: 2013-Aug-30
## | 4 position frequency matrices from 3 sources:
## |        JASPAR_2014:    2
## |        JASPAR_CORE:    1
## |          jolma2013:    1
## | 2 organism/s
## |           Hsapiens:    3
## |      Dmelanogaster:    1
## Hsapiens-JASPAR_CORE-CTCF-MA0139.1 
## Hsapiens-JASPAR_2014-CTCF-MA0139.1 
## Dmelanogaster-JASPAR_2014-CTCF-MA0531.1 
## Hsapiens-jolma2013-CTCF
```
---
## Finding motifs

We can extract a point weight matrix for CTCF which specifies the likelihood of a DNA base occurring in a CTCF motif. Here we extract the motif for CTCF from Human Jaspar Core database.


```r
names(CTCF)
```

```
## [1] "Hsapiens-JASPAR_CORE-CTCF-MA0139.1"     
## [2] "Hsapiens-JASPAR_2014-CTCF-MA0139.1"     
## [3] "Dmelanogaster-JASPAR_2014-CTCF-MA0531.1"
## [4] "Hsapiens-jolma2013-CTCF"
```

```r
ctcfMotif &lt;- CTCF[[1]]
ctcfMotif[,1:4]
```

```
##            1         2          3          4
## A 0.09529025 0.1829135 0.30777656 0.06133625
## C 0.31872946 0.1588171 0.05366922 0.87623220
## G 0.08324206 0.4534502 0.49178532 0.02300110
## T 0.50273823 0.2048193 0.14676889 0.03943045
```
---
## Visualising PWMs

We can visualise the frequency of DNA bases in our motif using the **seqLogo** package and the **seqLogo** function. 


```r
library(seqLogo)
seqLogo(ctcfMotif)
```

![](RU_ATAC_part2_files/figure-html/processData_motifCutsc-1.png)&lt;!-- --&gt;
---
## Searching for PWMs in DNAstring.

We can now use the **matchPWM()** function with our newly acquired CTCF PWM. 

Here we will search the sequence on Chr20 using the sequence provided within the BSgenome library for human **BSgenome.Hsapiens.UCSC.hg19**. 

The result is a **Views** object, similar to the IRanges object. We convert


```r
myRes &lt;- matchPWM(ctcfMotif,BSgenome.Hsapiens.UCSC.hg19[["chr20"]])
myRes
```

```
##   Views on a 63025520-letter DNAString subject
## subject: NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN...NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN
## views:
##           start      end width
##    [1]   239773   239791    19 [TTGCCACTGGGGGGAGACA]
##    [2]   246577   246595    19 [CAGCCCCCAGGTGGCAGCC]
##    [3]   335282   335300    19 [GTACCACTAGAGGGAGCTC]
##    [4]   360674   360692    19 [TCACCACTAGGCCGCACTG]
##    [5]   413626   413644    19 [TTGGCAGCAGGGGCCACCA]
##    ...      ...      ...   ... ...
## [1530] 62917490 62917508    19 [GCGCCAGCAGGGGGCGCTG]
## [1531] 62917548 62917566    19 [TCGCCAGCAGGGGGTGCAC]
## [1532] 62917607 62917625    19 [CTGCAAGCAGGGGGCGGTC]
## [1533] 62922628 62922646    19 [GCACCAGAAGGTGGCAGGA]
## [1534] 62922894 62922912    19 [GATCCAGCAAGGGGCGGCA]
```

---
  
## Searching for PWMs in DNAstring.

We need to convert the Views object to a GRanges so we can use these in soGGi to plot cut sites over.


```r
toCompare &lt;- GRanges("chr20",ranges(myRes))
toCompare
```

```
## GRanges object with 1534 ranges and 0 metadata columns:
##          seqnames               ranges strand
##             &lt;Rle&gt;            &lt;IRanges&gt;  &lt;Rle&gt;
##      [1]    chr20     [239773, 239791]      *
##      [2]    chr20     [246577, 246595]      *
##      [3]    chr20     [335282, 335300]      *
##      [4]    chr20     [360674, 360692]      *
##      [5]    chr20     [413626, 413644]      *
##      ...      ...                  ...    ...
##   [1530]    chr20 [62917490, 62917508]      *
##   [1531]    chr20 [62917548, 62917566]      *
##   [1532]    chr20 [62917607, 62917625]      *
##   [1533]    chr20 [62922628, 62922646]      *
##   [1534]    chr20 [62922894, 62922912]      *
##   -------
##   seqinfo: 1 sequence from an unspecified genome; no seqlengths
```

---
  
## Shifting reads for cut-sites.

To plot cut-sites we will wish to consider only the 5' end of reads and will need to adjust for a known offset of 5' reads to actual T5 cut-sites.

This will involve capturing the 5'end of reads and shifting reads on positive and negative strand by 4bp or -5bp respectively.

First we read in our nucleosome free region BAM file and extract read pairs.




```r
BAM &lt;- "~/Downloads/ATAC_Workshop/ATAC_Data/ATAC_BAM/Sorted_ATAC_50K_2_openRegions.bam"
atacReads_Open &lt;- readGAlignmentPairs(BAM)
read1 &lt;- first(atacReads_Open)
read2 &lt;- second(atacReads_Open)
read2[1,]
```


```
## GAlignments object with 1 alignment and 0 metadata columns:
##       seqnames strand       cigar    qwidth     start       end     width
##          &lt;Rle&gt;  &lt;Rle&gt; &lt;character&gt; &lt;integer&gt; &lt;integer&gt; &lt;integer&gt; &lt;integer&gt;
##   [1]    chr20      -         50M        50     60446     60495        50
##           njunc
##       &lt;integer&gt;
##   [1]         0
##   -------
##   seqinfo: 25 sequences from an unspecified genome
```

---
  
## Shifting reads for cut-sites.

Now we can shift the 5' end of both reads pairs by 4bp or -5bp depending on strand. This produces a GRanges of all our cut-sites from both reads.


```r
Firsts &lt;- resize(granges(read1),fix="start",1)
First_Pos_toCut &lt;- shift(granges(Firsts[strand(read1) == "+"]),
                                         4)
First_Neg_toCut &lt;- shift(granges(Firsts[strand(read1) == "-"]),
                                         -5)

Seconds &lt;- resize(granges(read2),fix="start",1)
Second_Pos_toCut &lt;- shift(granges(Seconds[strand(read2) == "+"]),
                                4)
Second_Neg_toCut &lt;- shift(granges(Seconds[strand(read2) == "-"]),
                                -5)

test_toCut &lt;- c(First_Pos_toCut,First_Neg_toCut,
                Second_Pos_toCut,Second_Neg_toCut)
test_toCut[1:2,]
```

```
## GRanges object with 2 ranges and 0 metadata columns:
##       seqnames         ranges strand
##          &lt;Rle&gt;      &lt;IRanges&gt;  &lt;Rle&gt;
##   [1]    chr20 [60440, 60440]      +
##   [2]    chr20 [60490, 60490]      -
##   -------
##   seqinfo: 25 sequences from an unspecified genome
```
---
  
## Coverage for cut-sites.

Now we can use the GRanges of cut-site positions to produce an RLElist of cut-sites across the genome using the **coverage()** function.



```r
cutsCoverage &lt;- coverage(test_toCut)
cutsCoverage20 &lt;- cutsCoverage["chr20"]
cutsCoverage20[[1]]
```

```
## integer-Rle of length 63025520 with 109971 runs
##   Lengths: 60439     1    49     1  1465 ...   561     1  5268     1 60295
##   Values :     0     1     0     2     0 ...     0     1     0     1     0
```
---
  
## Plotting for cut-sites.

We can use an RLElist with soGGi to produce a plot of cut-sites around our discovered CTCF motifs.

We change the **format** to rlelist and the **distanceAround** parameter to 500bp.


```r
CTCF_Cuts_open &lt;- regionPlot(cutsCoverage20,
                         testRanges = toCompare,
                         style = "point",
                         format="rlelist",distanceAround = 500)
```

---
  
## Plotting for cut-sites.

Now we can now plot our cut-sites using the **plotRegion()** function.


```r
plotRegion(CTCF_Cuts_open,outliers = 0.001)+
  ggtitle("NucFree Cuts Centred on CTCF")+theme_bw()
```

![](RU_ATAC_part2_files/figure-html/processData_motifCutsi-1.png)&lt;!-- --&gt;

---

# Time for an exercise.

[Link_to_exercises](../../Exercises/ATACseq_part2_exercises.html)

[Link_to_answers](../../Answers/ATACseq_part2_answers.html)
    </textarea>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function() {
  var d = document, s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})();</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
  }
});
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
